<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>父母說（指令遊戲）</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            text-align: center;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #4a4a4a;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #setup, #game-over-screen {
            padding: 20px;
        }
        #game-screen {
            display: none; /* Initially hidden */
        }
        /* MODIFICATION 1: Hide the full team lists */
        .teams-container {
            display: none;
        }
        #match-preview {
            background-color: #e7f3fe;
            border: 2px solid #b3d7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #match-preview p {
            font-size: 1.4em;
            margin: 5px 0;
            font-weight: bold;
        }
        #match-preview #next-matchup {
            font-size: 1.1em;
            font-weight: normal;
            color: #555;
        }
        #controls, #match-controls {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        textarea {
            width: 80%;
            height: 150px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        label {
            margin: 0 10px;
        }
        input[type="number"] {
            width: 80px;
            padding: 5px;
        }
        button {
            background-color: #5cb85c;
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            min-width: 160px;
        }
        button:hover {
            background-color: #4cae4c;
        }
        button.secondary {
            background-color: #f0ad4e;
        }
        button.secondary:hover {
            background-color: #ec971f;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #timer, #scores {
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px 0;
            color: #31708f;
        }
        #round-score {
            font-size: 1.3em;
            font-weight: bold;
            color: #d9534f;
            min-height: 30px;
        }
        #match-result {
            margin-top: 15px;
            font-size: 1.2em;
            min-height: 50px;
        }
        #match-result .winner { color: #3c763d; }
        #match-result .loser { color: #a94442; }
        #final-result {
            font-size: 2em;
            font-weight: bold;
            color: #d9534f;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>父母說 指令遊戲</h1>

        <!-- Setup Screen -->
        <div id="setup">
            <h2>遊戲設定</h2>
            <div id="controls">
                <label for="player-list"><strong>請輸入所有小朋友的名字（一行一個）：</strong></label><br>
                <textarea id="player-list">沛馨
知愛
宛汝
牧謙
筠縢
映安
允恩
允薆
心恩
晨蕊</textarea><br>
                <label for="game-time"><strong>遊戲時間（分鐘）：</strong></label>
                <input type="number" id="game-time" value="5" min="1">
                <br>
                <button id="start-game-btn">開始遊戲</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen">
            <div id="timer">05:00</div>
            <div id="scores">順從神: 0 - 服從人: 0</div>
            
            <!-- MODIFICATION 1: New focused display area -->
            <div id="match-preview">
                <p id="current-matchup">本輪對戰：</p>
                <p id="next-matchup">下組預備：</p>
            </div>

            <div id="match-controls">
                <h3>回合計分 (三戰兩勝)</h3>
                <p>請先猜拳，然後進行遊戲。觀察後，點擊下方按鈕記錄該回合勝利者。</p>
                <div id="round-score"></div>
                <button id="win-A-btn">A隊 回合勝利</button>
                <button id="win-B-btn">B隊 回合勝利</button>
                <div id="match-result"></div>
                <button id="next-round-btn" style="display: none;" class="secondary">下一組</button>
            </div>
            
            <!-- This container is now hidden but used by the script -->
            <div class="teams-container">
                <div id="teamA" class="team"><h2>順從神</h2><ol id="teamA-list"></ol></div>
                <div id="teamB" class="team"><h2>服從人</h2><ol id="teamB-list"></ol></div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" style="display:none;">
            <h2>遊戲結束！</h2>
            <div id="final-result"></div>
            <p>謝謝大家的參與！你們都表現得很棒！</p>
            <button onclick="location.reload()">重新開始</button>
        </div>
    </div>

    <audio id="win-sound" src="https://www.soundjay.com/buttons/sounds/button-1.mp3" preload="auto"></audio>
    <audio id="end-sound" src="https://www.soundjay.com/misc/sounds/tada-fanfare-a.mp3" preload="auto"></audio>

<script>
    // --- DOM Elements ---
    const setupScreen = document.getElementById('setup');
    const gameScreen = document.getElementById('game-screen');
    const gameOverScreen = document.getElementById('game-over-screen');

    const playerListTextarea = document.getElementById('player-list');
    const gameTimeInput = document.getElementById('game-time');
    const startGameBtn = document.getElementById('start-game-btn');

    const timerDisplay = document.getElementById('timer');
    const scoresDisplay = document.getElementById('scores');
    const teamAList = document.getElementById('teamA-list');
    const teamBList = document.getElementById('teamB-list');

    const currentMatchupDisplay = document.getElementById('current-matchup');
    const nextMatchupDisplay = document.getElementById('next-matchup');
    const roundScoreDisplay = document.getElementById('round-score');

    const winABtn = document.getElementById('win-A-btn');
    const winBBtn = document.getElementById('win-B-btn');
    const matchResultDisplay = document.getElementById('match-result');
    const nextRoundBtn = document.getElementById('next-round-btn');

    const finalResultDisplay = document.getElementById('final-result');
    const winSound = document.getElementById('win-sound');
    const endSound = document.getElementById('end-sound');

    // --- Game State ---
    let teamA = [], teamB = [];
    let teamAScore = 0, teamBScore = 0;
    let currentPairIndex = 0;
    // MODIFICATION 2: Re-add round win tracking
    let roundWinsA = 0, roundWinsB = 0;
    let timerInterval;

    // --- Event Listeners ---
    startGameBtn.addEventListener('click', startGame);
    // MODIFICATION 2: Point buttons to the round win function
    winABtn.addEventListener('click', () => recordRoundWin('A'));
    winBBtn.addEventListener('click', () => recordRoundWin('B'));
    nextRoundBtn.addEventListener('click', () => {
        currentPairIndex++;
        setupNextRound();
    });

    // --- Functions ---
    function startGame() {
        let players = playerListTextarea.value.split('\n').map(p => p.trim()).filter(p => p);
        if (players.length < 2) {
            alert("至少需要兩位小朋友才能開始遊戲喔！");
            return;
        }
        players.sort(() => 0.5 - Math.random());

        const midIndex = Math.ceil(players.length / 2);
        teamA = players.slice(0, midIndex);
        teamB = players.slice(midIndex);
        if (teamA.length > teamB.length) teamB.push("輪空");

        teamAList.innerHTML = teamA.map(p => `<li>${p}</li>`).join('');
        teamBList.innerHTML = teamB.map(p => `<li>${p}</li>`).join('');
        
        setupScreen.style.display = 'none';
        gameScreen.style.display = 'block';

        let time = parseInt(gameTimeInput.value) * 60;
        startTimer(time);
        setupNextRound();
    }

    function startTimer(duration) {
        let remaining = duration;
        timerInterval = setInterval(() => {
            const minutes = String(Math.floor(remaining / 60)).padStart(2, '0');
            const seconds = String(remaining % 60).padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
            if (--remaining < 0) endGame("時間到");
        }, 1000);
    }
    
    function setupNextRound() {
        if (currentPairIndex >= teamA.length) currentPairIndex = 0; // Loop back

        // MODIFICATION 2: Reset round state for the new match
        roundWinsA = 0;
        roundWinsB = 0;

        const playerA = teamA[currentPairIndex];
        const playerB = teamB[currentPairIndex];
        
        // MODIFICATION 1: Update the new focused display
        currentMatchupDisplay.textContent = `本輪對戰： ${playerA} (順從神) vs ${playerB} (服從人)`;
        
        const nextPairIndex = (currentPairIndex + 1) % teamA.length;
        const nextPlayerA = teamA[nextPairIndex];
        const nextPlayerB = teamB[nextPairIndex];
        nextMatchupDisplay.textContent = `下組預備： ${nextPlayerA} vs ${nextPlayerB}`;

        // Handle "Bye" rounds automatically
        if (playerA === "輪空" || playerB === "輪空") {
            handleByeRound();
            return;
        }

        matchResultDisplay.innerHTML = '';
        roundScoreDisplay.textContent = '回合比分： 0 - 0';
        winABtn.textContent = `${playerA} 回合勝利`;
        winBBtn.textContent = `${playerB} 回合勝利`;
        winABtn.disabled = false;
        winBBtn.disabled = false;
        nextRoundBtn.style.display = 'none';
    }
    
    function handleByeRound() {
        const winnerTeam = teamA[currentPairIndex] !== "輪空" ? 'A' : 'B';
        const winnerPlayer = winnerTeam === 'A' ? teamA[currentPairIndex] : teamB[currentPairIndex];
        
        if (winnerTeam === 'A') teamAScore++;
        else teamBScore++;
        updateScores();
        
        matchResultDisplay.innerHTML = `<p class="winner">${winnerPlayer} 本輪輪空，自動獲勝得1分！</p>
                                        <p><strong>目前總比分：順從神 ${teamAScore} - 服從人 ${teamBScore}</strong></p>`;
        
        winABtn.disabled = true;
        winBBtn.disabled = true;
        nextRoundBtn.style.display = 'block';
    }

    // MODIFICATION 2: Function to record a single round's win
    function recordRoundWin(winner) {
        winSound.play();
        if (winner === 'A') roundWinsA++;
        else roundWinsB++;
        
        roundScoreDisplay.textContent = `回合比分： ${roundWinsA} - ${roundWinsB}`;

        if (roundWinsA >= 2 || roundWinsB >= 2) {
            endMatch();
        }
    }

    // MODIFICATION 2: Function to end the match after 2 wins
    function endMatch() {
        const matchWinner = roundWinsA > roundWinsB ? 'A' : 'B';
        const winnerPlayer = matchWinner === 'A' ? teamA[currentPairIndex] : teamB[currentPairIndex];
        const loserPlayer = matchWinner === 'A' ? teamB[currentPairIndex] : teamA[currentPairIndex];

        if (matchWinner === 'A') teamAScore++;
        else teamBScore++;
        updateScores();

        matchResultDisplay.innerHTML = `
            <p class="winner"><strong>${winnerPlayer} 贏了這一組！</strong> 請大家一起為他/她唸：「順從父母！」</p>
            <p class="loser"><strong>${loserPlayer} 也非常努力！</strong> 請唸出我們的口訣：<br>
            三字訣：「順從神、服從人」<br>
            七字訣：「信而順從神喜愛 服從權柄不頂撞」</p>
            <hr>
            <p><strong>目前總比分：順從神 ${teamAScore} - 服從人 ${teamBScore}</strong></p>
        `;
        
        winABtn.disabled = true;
        winBBtn.disabled = true;
        nextRoundBtn.style.display = 'block';
    }

    function updateScores() {
        scoresDisplay.textContent = `順從神: ${teamAScore} - 服從人: ${teamBScore}`;
    }

    function endGame(reason) {
        clearInterval(timerInterval);
        endSound.play();

        let resultText = '';
        if (teamAScore > teamBScore) {
            resultText = `「順從神」隊獲勝！恭喜！`;
        } else if (teamBScore > teamAScore) {
            resultText = `「服從人」隊獲勝！恭喜！`;
        } else {
            resultText = `平手！兩隊都非常厲害！`;
        }
        
        finalResultDisplay.textContent = `${reason}！最終比分 ${teamAScore} : ${teamBScore}。 ${resultText}`;
        gameScreen.style.display = 'none';
        gameOverScreen.style.display = 'block';
    }
</script>

</body>
</html>
